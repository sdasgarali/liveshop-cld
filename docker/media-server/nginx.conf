worker_processes auto;
rtmp_auto_push on;

events {
    worker_connections 1024;
}

# RTMP configuration for live streaming
rtmp {
    server {
        listen 1935;
        chunk_size 4096;

        # Timeout settings
        timeout 30s;
        ping 30s;
        ping_timeout 15s;

        application live {
            live on;
            record off;

            # Authentication via on_publish callback
            on_publish http://api:3001/api/v1/streams/webhook/publish;
            on_publish_done http://api:3001/api/v1/streams/webhook/unpublish;

            # HLS output
            hls on;
            hls_path /tmp/hls;
            hls_fragment 2s;
            hls_playlist_length 10s;
            hls_cleanup on;
            hls_continuous on;

            # DASH output (optional)
            dash on;
            dash_path /tmp/dash;
            dash_fragment 2s;
            dash_playlist_length 10s;

            # Thumbnail generation
            exec_push ffmpeg -i rtmp://localhost:1935/live/$name
                -vf "fps=1/5,scale=640:-1"
                -update 1
                -y /tmp/hls/$name/thumb.jpg;

            # Transcoding for adaptive bitrate (optional - resource intensive)
            # exec_push ffmpeg -i rtmp://localhost:1935/live/$name
            #     -c:v libx264 -preset veryfast -b:v 3000k -maxrate 3000k -bufsize 6000k -s 1280x720 -c:a aac -b:a 128k -f flv rtmp://localhost:1935/hls/$name_720p
            #     -c:v libx264 -preset veryfast -b:v 1500k -maxrate 1500k -bufsize 3000k -s 854x480 -c:a aac -b:a 96k -f flv rtmp://localhost:1935/hls/$name_480p
            #     -c:v libx264 -preset veryfast -b:v 800k -maxrate 800k -bufsize 1600k -s 640x360 -c:a aac -b:a 64k -f flv rtmp://localhost:1935/hls/$name_360p;

            # Allowed encoders
            allow publish all;
            allow play all;

            # Drop idle streams after 30 seconds
            drop_idle_publisher 30s;
        }

        # Relay to external services (optional)
        # application relay {
        #     live on;
        #     push rtmp://live.twitch.tv/app/${TWITCH_STREAM_KEY};
        #     push rtmp://a.rtmp.youtube.com/live2/${YOUTUBE_STREAM_KEY};
        # }
    }
}

http {
    include mime.types;
    default_type application/octet-stream;

    sendfile on;
    keepalive_timeout 65;

    # Gzip compression
    gzip on;
    gzip_types application/vnd.apple.mpegurl video/mp2t application/dash+xml;

    server {
        listen 8080;
        server_name localhost;

        # CORS headers
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;

        # HLS streaming
        location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
                image/jpeg jpg;
            }

            alias /tmp/hls;

            # Disable cache for live content
            add_header Cache-Control no-cache;
            add_header 'Access-Control-Allow-Origin' '*' always;
        }

        # DASH streaming
        location /dash {
            types {
                application/dash+xml mpd;
                video/mp4 m4s mp4;
            }

            alias /tmp/dash;

            add_header Cache-Control no-cache;
            add_header 'Access-Control-Allow-Origin' '*' always;
        }

        # Thumbnails
        location /thumb {
            alias /tmp/hls;

            add_header Cache-Control "no-cache, max-age=5";
            add_header 'Access-Control-Allow-Origin' '*' always;
        }

        # Health check
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }

        # Stream statistics (RTMP stat)
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }

        location /stat.xsl {
            root /usr/local/nginx/html;
        }

        # Control interface for dropping streams
        location /control {
            rtmp_control all;
        }
    }
}
